<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Patel Craftex - Multi-Punch</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* CSS STYLES */
        :root { 
            --pb-blue: #1040D5; 
            --bg: #F0F2F5; 
            --card-bg: #ffffff;
            --text-main: #1C1E21;
            --text-sub: #666666;
            --border: #eeeeee;
            --green: #25D366; 
            --red: #FF3B30; 
            --orange: #FF9500; 
        }

        /* DARK MODE VARIABLES */
        body.dark-mode {
            --pb-blue: #3b6bf9;
            --bg: #121212;
            --card-bg: #1e1e1e;
            --text-main: #e0e0e0;
            --text-sub: #a0a0a0;
            --border: #333333;
        }

        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text-main); margin: 0; display: flex; justify-content: center; height: 100vh; overflow: hidden; transition: background 0.3s, color 0.3s; }
        .mobile-frame { width: 100%; max-width: 450px; background: var(--card-bg); display: flex; flex-direction: column; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.1); height: 100%; }
        
        /* LOGIN SCREEN */
        #loginScreen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; }
        .login-logo { width: 80px; height: 80px; background: var(--pb-blue); border-radius: 15px; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem; font-weight: bold; box-shadow: 0 10px 20px rgba(16, 64, 213, 0.3); }
        .login-box { background: var(--card-bg); padding: 30px; border-radius: 12px; width: 100%; max-width: 300px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: center; border: 1px solid var(--border); }
        
        /* HEADER */
        .header { background: var(--pb-blue); color: white; padding: 15px 15px 5px 15px; flex-shrink: 0; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .business-name { font-weight: 700; font-size: 1.2rem; }
        
        .cal-wrapper { position: relative; display: inline-block; cursor: pointer; }
        .cal-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 12px; border-radius: 6px; display: flex; align-items: center; gap: 8px; font-size: 0.9rem; font-weight: 500; pointer-events: none; }
        .date-input-hidden { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 10; }

        .date-strip { display: flex; justify-content: space-between; text-align: center; margin-top: 10px; }
        .date-item { display: flex; flex-direction: column; align-items: center; width: 18%; opacity: 0.6; cursor: pointer; color: white; padding-bottom: 10px; position: relative; }
        .date-item.active { opacity: 1; font-weight: bold; }
        .date-item.active::after { content: ''; position: absolute; bottom: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-bottom: 6px solid #F0F2F5; }
        .date-day { font-size: 0.7rem; text-transform: uppercase; font-weight: 600; }
        .date-num { font-size: 1.2rem; font-weight: 700; margin-top: 2px; }

        /* STATS */
        .stats-row { display: flex; gap: 10px; padding: 15px; background: var(--bg); margin-top: -1px; }
        .stat-card { flex: 1; background: var(--card-bg); border-radius: 8px; padding: 15px 5px; text-align: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05); border: 1px solid var(--border); }
        .stat-val { display: block; font-size: 1.2rem; font-weight: 700; margin-bottom: 2px; }
        .stat-lbl { font-size: 0.75rem; color: var(--text-sub); }

        /* VIEWS */
        .view-section { display: none; flex: 1; overflow-y: auto; background: var(--bg); padding-bottom: 80px; }
        .view-section.active { display: block; }

        /* CARDS */
        .staff-list { padding: 0 15px; }
        .staff-card { background: var(--card-bg); padding: 15px; border-radius: 8px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); cursor: pointer; border: 1px solid var(--border); }
        .card-row-top { display: flex; justify-content: space-between; align-items: center; }
        .card-row-bottom { display: flex; justify-content: space-between; border-top: 1px solid var(--border); padding-top: 10px; }

        .avatar { width: 40px; height: 40px; background: #EBF0FF; color: var(--pb-blue); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 12px; font-size: 1.1rem; }
        .pill { padding: 4px 12px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; }
        .pill-in { background: #e7fcf0; color: #0a6c38; }
        .pill-out { background: #f0f2f5; color: #666; }
        .pill-absent { background: #ffebeb; color: var(--red); border: 1px solid #ffcccc; }
        .pill-idle { background: #f0f2f5; color: #666; }
        .pill-overtime { background: #fff3e0; color: var(--orange); border: 1px solid #ffcc80; }


        .mini-stat { display: flex; flex-direction: column; text-align: center; flex: 1; }
        .mini-stat:first-child { text-align: left; }
        .mini-stat:last-child { text-align: right; }
        .mini-label { font-size: 0.65rem; color: var(--text-sub); text-transform: uppercase; margin-bottom: 3px; }
        .mini-val { font-size: 0.95rem; font-weight: 600; font-family: monospace; }
        
        .val-work { color: var(--text-main); }
        .val-total { color: var(--text-sub); }
        .ticking { color: var(--pb-blue); }

        /* MANAGE STAFF */
        .add-staff-box { background: var(--card-bg); padding: 20px; margin: 15px; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); border: 1px solid var(--border); }
        .input-row { display: flex; gap: 10px; }
        .pb-input { flex: 1; padding: 12px; border: 1px solid var(--border); background: var(--bg); color: var(--text-main); border-radius: 6px; font-size: 1rem; }
        .pb-btn { background: var(--pb-blue); color: white; border: none; padding: 0 20px; border-radius: 6px; font-weight: bold; cursor: pointer; }
        .manage-list { padding: 0 15px; }
        .manage-item { background: var(--card-bg); padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .manage-item:first-child { border-top-left-radius: 8px; border-top-right-radius: 8px; }
        .manage-item:last-child { border-bottom-left-radius: 8px; border-bottom-right-radius: 8px; border-bottom: none; }

        /* HISTORY */
        .history-controls { padding: 15px; display:flex; gap:10px; justify-content: center; }
        .history-btn { padding: 8px 15px; border-radius: 20px; border: 1px solid var(--border); background: var(--card-bg); color: var(--text-sub); font-size: 0.85rem; font-weight: 600; cursor: pointer; }
        .history-btn.active { background: var(--pb-blue); color: white; border-color: var(--pb-blue); }

        .history-date-block { background: var(--card-bg); margin-bottom: 10px; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); overflow: hidden; margin-left: 15px; margin-right: 15px; border: 1px solid var(--border); }
        .h-header { background: var(--bg); padding: 10px 15px; font-weight: bold; font-size: 0.9rem; color: var(--text-main); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; }
        .h-row { padding: 12px 15px; border-bottom: 1px solid var(--border); display: flex; flex-direction: column; gap: 5px; }
        .h-main-row { display: flex; justify-content: space-between; font-size: 0.95rem; }
        .h-name { font-weight: 600; color: var(--text-main); }
        .h-time { font-family: monospace; color: var(--pb-blue); font-weight: 600; }
        .h-details { display: flex; gap: 10px; font-size: 0.75rem; color: var(--text-sub); background: var(--bg); padding: 5px 8px; border-radius: 4px; }
        .h-detail-item { display: flex; align-items: center; gap: 4px; }

        /* PROFILE (Revamped) */
        .profile-container { padding: 20px; background: var(--bg); min-height: 100%; box-sizing: border-box; }
        .setting-card { background: var(--card-bg); border-radius: 12px; padding: 0; box-shadow: 0 1px 3px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid var(--border); overflow: hidden; }
        
        .setting-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid var(--border); }
        .setting-item:last-child { border-bottom: none; }
        
        .setting-label { font-weight: 500; font-size: 0.95rem; display: flex; align-items: center; gap: 10px; }
        .setting-label i { width: 24px; text-align: center; color: var(--pb-blue); }
        
        /* Toggle Switch */
        .switch { position: relative; display: inline-block; width: 40px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 22px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--pb-blue); }
        input:checked + .slider:before { transform: translateX(18px); }

        .made-by { text-align: center; margin-top: 30px; margin-bottom: 40px; color: var(--text-sub); }
        .made-by img { width: 50px; height: 50px; border-radius: 10px; margin-bottom: 10px; background: #ddd; }
        .made-by h4 { margin: 0; font-size: 1rem; color: var(--text-main); }
        .made-by p { margin: 2px 0 0 0; font-size: 0.75rem; }

        .bottom-nav { background: var(--card-bg); border-top: 1px solid var(--border); display: flex; justify-content: space-around; padding: 10px 0; position: absolute; bottom: 0; width: 100%; z-index: 10; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #9CA3AF; font-size: 0.7rem; gap: 4px; cursor: pointer; }
        .nav-item.active { color: var(--pb-blue); font-weight: 600; }
        .nav-item i { font-size: 1.3rem; }

        /* FAB - UPDATED to be Translucent */
        .fab { 
            position: absolute; bottom: 80px; right: 20px; 
            background: rgba(16, 64, 213, 0.8); /* Translucent Blue */
            color: white; width: 56px; height: 56px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 1.8rem; border: none; cursor: pointer; 
            box-shadow: 0 4px 12px rgba(16, 64, 213, 0.4); 
            z-index: 5; transition: transform 0.2s; 
            backdrop-filter: blur(4px); /* Blur effect */
        }
        .fab:active { transform: scale(0.95); }

        /* MODALS & OVERLAYS */
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 20; display: none; align-items: flex-end; }
        .sheet { background: var(--card-bg); width: 100%; border-radius: 20px 20px 0 0; padding: 25px; box-sizing: border-box; animation: slideUp 0.25s; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .timer-grid { display: flex; gap: 10px; margin: 20px 0; justify-content: center; }
        .timer-box { flex: 1; max-width: 200px; background: var(--bg); padding: 15px 5px; border-radius: 8px; text-align: center; border: 1px solid var(--border); }
        .t-val { display: block; font-size: 1.6rem; font-weight: 700; font-family: monospace; color: var(--pb-blue); }
        .t-lbl { font-size: 0.75rem; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 5px;}

        .action-btn { width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 10px;}
        .btn-absent { background: #fee2e2; color: var(--red); }
        .btn-trash { color: #ccc; cursor: pointer; font-size: 1.2rem; }
        .btn-trash { color: #ccc; cursor: pointer; font-size: 1.2rem; }
        .btn-trash:hover { color: var(--red); }
        
        .select-item { padding: 15px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .manual-box { background:var(--bg); padding:15px; border-radius:8px; margin-bottom:15px; border:1px solid var(--border); }

        /* TOAST & CONFIRM */
        #toastContainer { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); z-index: 1100; display: flex; flex-direction: column; gap: 10px; pointer-events: none; width: 90%; max-width: 400px; }
        .toast { background: #333; color: white; padding: 12px 16px; border-radius: 8px; font-size: 0.9rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); opacity: 0; transform: translateY(20px); transition: all 0.3s; text-align: center; pointer-events: auto; }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.success { background: #0a6c38; }
        .toast.error { background: #d32f2f; }

        .confirm-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1200; display: none; align-items: center; justify-content: center; }
        .confirm-box { background: var(--card-bg); width: 85%; max-width: 320px; border-radius: 12px; padding: 20px; text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.2); animation: popIn 0.2s; }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .confirm-title { font-weight: bold; font-size: 1.1rem; margin-bottom: 8px; }
        .confirm-msg { color: var(--text-sub); font-size: 0.9rem; margin-bottom: 20px; }
        .confirm-actions { display: flex; gap: 10px; }
        .c-btn { flex: 1; padding: 10px; border-radius: 6px; font-weight: bold; border: none; cursor: pointer; font-size: 0.9rem; }
        .c-cancel { background: var(--bg); color: var(--text-main); }
        .c-confirm { background: var(--pb-blue); color: white; }
        .c-delete { background: var(--red); color: white; }

        @media screen and (max-width: 600px) {
            body { background: var(--bg); height: 100dvh; width: 100vw; overflow: hidden; position: fixed; margin: 0; }
            .mobile-frame { height: 100%; width: 100%; max-width: 100%; border-radius: 0; box-shadow: none; display: flex; flex-direction: column; }
            .view-section { flex: 1; overflow-y: auto; padding-bottom: 90px; -webkit-overflow-scrolling: touch; }
            .bottom-nav { position: absolute; bottom: 0; width: 100%; padding-bottom: env(safe-area-inset-bottom); background: var(--card-bg); }
            .fab { bottom: calc(80px + env(safe-area-inset-bottom)); right: 20px; }
        }
    </style>
</head>
<body>

<div class="mobile-frame">
    <div id="toastContainer"></div>
    <div id="customConfirm" class="confirm-overlay">
        <div class="confirm-box">
            <div class="confirm-title" id="confirmTitle">Confirm</div>
            <div class="confirm-msg" id="confirmMsg">Are you sure?</div>
            <div class="confirm-actions">
                <button class="c-btn c-cancel" onclick="closeConfirm()">Cancel</button>
                <button class="c-btn c-confirm" id="confirmBtnYes">Confirm</button>
            </div>
        </div>
    </div>

    <div id="loginScreen">
        <div class="login-logo">
            <i class="fas fa-fingerprint"></i>
        </div>
        <div class="login-box">
            <h3 style="margin-top:0; color:var(--text-main);">Welcome</h3>
            <div style="font-size:0.85rem; color:var(--text-sub); margin-bottom:20px;">Please enter password to access.</div>
            <input type="password" id="loginPassInput" class="pb-input" placeholder="Password" style="text-align:center; letter-spacing:5px; margin-bottom:15px; font-size:1.2rem;">
            <button class="pb-btn" onclick="checkLogin()" style="width:100%; padding:15px;">LOGIN</button>
        </div>
    </div>

    <div id="mainApp" style="display:none; height:100%; flex-direction:column;">
        
        <div class="overlay" id="monthSelectModal" onclick="if(event.target===this) closeMonthModal()">
            <div class="sheet">
                <h3 style="color:var(--text-main);" id="monthSelectTitle">Select Month</h3>
                <div style="font-size:0.8rem; color:var(--text-sub); margin-bottom:15px;">View report for:</div>
                <input type="month" id="reportMonthInput" class="pb-input" style="width:100%; box-sizing:border-box; margin-bottom:20px;">
                <button class="action-btn" onclick="generateStaffReport()" style="background:var(--pb-blue); color:white;">View Report</button>
                <button class="action-btn" onclick="closeMonthModal()" style="background:var(--bg); color:var(--text-main); margin-top:10px;">Cancel</button>
            </div>
        </div>

        <div class="header">
            <div class="top-bar">
                <div class="business-name" id="displayBizName">My Business</div>
                <label class="cal-wrapper">
                    <div class="cal-btn">
                        <i class="fas fa-calendar-alt"></i> <span>Pick Date</span>
                    </div>
                    <input type="date" class="date-input-hidden" onchange="pickDate(this.value)">
                </label>
            </div>
            <div class="date-strip" id="dateStrip"></div>
        </div>

        <div id="statsRow" class="stats-row">
            <div class="stat-card">
                <span class="stat-val" id="statP" style="color:var(--green)">0</span>
                <span class="stat-lbl">Present</span>
            </div>
            <div class="stat-card">
                <span class="stat-val" id="statA" style="color:var(--red)">0</span>
                <span class="stat-lbl">Absent</span>
            </div>
            <div class="stat-card">
                <span class="stat-val" id="statH">0h</span>
                <span class="stat-lbl">Total Hours</span>
            </div>
        </div>

        <div id="view-attendance" class="view-section active">
            <div class="staff-list" id="attendanceContainer"></div>
            <button class="fab" onclick="openSelectStaffModal()"><i class="fas fa-plus"></i></button>
        </div>

        <div id="view-history" class="view-section">
            <div class="history-controls">
                <div class="history-btn active" id="btnHistDaily" onclick="setHistoryMode('daily')">Daily View</div>
                <div class="history-btn" id="btnHistStaff" onclick="setHistoryMode('staff')">By Staff</div>
            </div>
            <div id="historyContainer" style="padding:10px;"></div>
        </div>

        <div id="view-staff" class="view-section">
            <div class="add-staff-box">
                <div style="margin-bottom:10px; font-weight:bold;">Add New Employee</div>
                <div class="input-row">
                    <input type="text" id="newStaffInput" class="pb-input" placeholder="e.g. Jil Patel">
                    <button class="pb-btn" onclick="addNewStaff()">ADD</button>
                </div>
            </div>
            <div style="padding:0 15px 10px 15px; font-size:0.8rem; color:var(--text-sub); font-weight:bold; text-transform:uppercase;">Your Staff List</div>
            <div class="manage-list" id="manageStaffContainer"></div>
        </div>

        <div id="view-profile" class="view-section">
            <div class="profile-container">
                <div class="setting-card">
                    <div class="setting-item">
                        <div class="setting-label"><i class="fas fa-briefcase"></i> Business Name</div>
                        <input type="text" id="bizNameInput" class="pb-input" style="width:150px; padding:8px;" onblur="saveProfile()">
                    </div>
                </div>

                <div class="setting-card">
                    <div class="setting-item">
                        <div class="setting-label"><i class="fas fa-moon"></i> Dark Mode</div>
                        <label class="switch">
                            <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                
                <div class="setting-card">
                    <div class="setting-item">
                        <div class="setting-label"><i class="fas fa-clock"></i> Default Hours</div>
                        <input type="number" id="defaultHoursInput" class="pb-input" style="width:60px; padding:8px;" value="8" min="1" max="24" step="0.5" onblur="saveProfile()">
                    </div>
                </div>

                <div class="setting-card">
                    <div class="setting-item">
                        <div class="setting-label"><i class="fas fa-lock"></i> Change Password</div>
                        <input type="password" id="passwordInput" class="pb-input" style="width:100px; padding:8px;" placeholder="****" onblur="saveProfile()">
                    </div>
                </div>

                <div class="setting-card">
                    <div class="setting-item" onclick="exportToExcel()" style="cursor:pointer;">
                        <div class="setting-label"><i class="fas fa-file-excel" style="color:var(--green)"></i> Export to Excel (CSV)</div>
                        <i class="fas fa-chevron-right" style="color:#ccc;"></i>
                    </div>
                    <div class="setting-item" onclick="resetAllData()" style="cursor:pointer; color:var(--red);">
                        <div class="setting-label" style="color:var(--red);"><i class="fas fa-trash-alt" style="color:var(--red);"></i> Reset All Data</div>
                    </div>
                </div>

                <div class="made-by">
                    <img src="images/logo.jpeg" alt="Logo">
                    <p>Designed for Patel Craftex</p>
                    <p style="margin-top:5px; font-size:0.7rem;">Made by Dhruv Patel</p>
                </div>
            </div>
        </div>

        <div class="bottom-nav">
            <div class="nav-item active" onclick="switchTab('attendance', this)">
                <i class="fas fa-users"></i><span>Attendance</span>
            </div>
            <div class="nav-item" onclick="switchTab('history', this)">
                <i class="fas fa-history"></i><span>History</span>
            </div>
            <div class="nav-item" onclick="switchTab('staff', this)">
                <i class="fas fa-user-cog"></i><span>Staff</span>
            </div>
            <div class="nav-item" onclick="switchTab('profile', this)">
                <i class="fas fa-store"></i><span>Profile</span>
            </div>
        </div>

        <div class="overlay" id="actionModal" onclick="if(event.target===this) closeModal()">
            <div class="sheet">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h3 id="modalName" style="margin:0; color:var(--text-main);">Name</h3>
                    <i class="fas fa-trash-alt btn-trash" onclick="removeStaffFromDay()" title="Remove from Today"></i>
                </div>
                
                <div class="timer-grid">
                    <div class="timer-box" style="background:#eef2ff; border-color:#dbeafe;">
                        <span class="t-val" id="modalTotalTimer" style="color:var(--pb-blue)">00:00:00</span>
                        <span class="t-lbl">Total Work Time</span>
                    </div>
                </div>

                <div id="modalActions"></div>

                <div id="modalManualSection" class="manual-box">
                    <div style="font-size:0.8rem; color:var(--text-sub); margin-bottom:10px; font-weight:bold; text-transform:uppercase;">Manual Correction</div>
                    <div id="punchEditList" style="display:flex; flex-direction:column; gap:8px;"></div>
                    <button class="action-btn" onclick="addNewPunch()" style="background:var(--pb-blue); color:white; margin-top:10px; font-size:0.85rem;">+ Add Punch</button>
                </div>

                <button class="action-btn" onclick="closeModal()" style="background:var(--bg); color:var(--text-main); margin-top:10px;">Close</button>
            </div>
        </div>

        <div class="overlay" id="selectStaffModal" onclick="if(event.target===this) closeSelectModal()">
            <div class="sheet">
                <h3 style="color:var(--text-main);">Add to List</h3>
                <div style="font-size:0.8rem; color:var(--text-sub); margin-bottom:15px;">Tap a name to add them to the attendance list for this date.</div>
                <div id="selectStaffList"></div>
                <button class="action-btn" onclick="closeSelectModal()" style="background:var(--bg); color:var(--text-main); margin-top:15px;">Cancel</button>
            </div>
        </div>
    </div> </div>

<script>
    // --- UTILS ---
    function showToast(msg, type='info') {
        const c = document.getElementById('toastContainer');
        const t = document.createElement('div');
        t.className = `toast ${type}`;
        t.innerText = msg;
        c.appendChild(t);
        void t.offsetWidth; 
        t.classList.add('show');
        setTimeout(() => {
            t.classList.remove('show');
            setTimeout(() => { if(t.parentNode) t.parentNode.removeChild(t); }, 300);
        }, 3000);
    }

    let confirmCallback = null;
    function showConfirm(msg, callback, isDelete=false) {
        document.getElementById('confirmMsg').textContent = msg;
        document.getElementById('confirmTitle').textContent = isDelete ? 'Delete?' : 'Confirm';
        const btn = document.getElementById('confirmBtnYes');
        btn.className = isDelete ? 'c-btn c-delete' : 'c-btn c-confirm';
        btn.textContent = isDelete ? 'Delete' : 'Confirm';
        confirmCallback = callback;
        document.getElementById('customConfirm').style.display = 'flex';
    }
    function closeConfirm() { document.getElementById('customConfirm').style.display = 'none'; confirmCallback = null; }
    document.getElementById('confirmBtnYes').onclick = function() { if(confirmCallback) confirmCallback(); closeConfirm(); };

    // --- DATE FIX: GET LOCAL DATE STRING CORRECTLY ---
    function getLocalDateString() {
        const d = new Date();
        return new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
    }

    // --- DATA ---
    let db_staff = JSON.parse(localStorage.getItem('pb_db_staff')) || []; 
    // db_live schema: { state: 'in'|'out', lastAction: ts, totalWorkMs: int, currentStart: ts, date: 'yyyy-mm-dd', punches: [{type:'in'|'out', time:ts}] }
    let db_live = JSON.parse(localStorage.getItem('pb_live_data')) || {};
    let db_history = JSON.parse(localStorage.getItem('pb_history_data')) || {};
    let db_removed = JSON.parse(localStorage.getItem('pb_removed_data')) || {};
    let db_bizName = localStorage.getItem('pb_bizName') || 'My Business';
    let db_prefs = JSON.parse(localStorage.getItem('pb_prefs')) || { dark: false };
    
    // Settings
    let db_defaultHours = parseFloat(localStorage.getItem('pb_defaultHours')) || 8;
    let db_password = localStorage.getItem('pb_password') || '1234';

    // Migration: Add defaultHours to existing staff if not present
    let migrationNeeded = false;
    db_staff.forEach(s => {
        if (!s.hasOwnProperty('defaultHours')) {
            s.defaultHours = 8;
            migrationNeeded = true;
        }
    });
    if (migrationNeeded) {
        localStorage.setItem('pb_db_staff', JSON.stringify(db_staff));
    }

    let appState = {
        todayStr: getLocalDateString(),
        selectedDate: getLocalDateString(),
        activeStaffId: null,
        historyMode: 'daily', // 'daily' or 'staff'
        reportStaff: null
    };

    // --- CORE FIX 1: CHECK FOR NEW DAY ON LOAD ---
    // If the date stored in local storage is different from today, RESET LIVE DATA
    function checkNewDayReset() {
        const storedDate = localStorage.getItem('pb_last_app_date');
        
        // If app hasn't been opened today, reset everything
        if (storedDate && storedDate !== appState.todayStr) {
            // Archive old live data if it exists
            archiveAndResetLiveData(storedDate);
        }
        localStorage.setItem('pb_last_app_date', appState.todayStr);
    }
    
    function archiveAndResetLiveData(oldDate) {
        // Optional: Move any stuck "Live" data to history for the previous day
        // This handles the "I left it open overnight" case
        Object.keys(db_live).forEach(name => {
             const l = db_live[name];
             if (l.totalWorkMs > 0 || l.state === 'in') {
                 if (!db_history[oldDate]) db_history[oldDate] = {};
                 // If they were still 'in', cap it? For now, just save what was accumulated.
                 db_history[oldDate][name] = {
                     workMs: l.totalWorkMs,
                     startTime: l.startTime,
                     endTime: l.lastAction, // Approximated
                     status: 'present',
                     punches: l.punches || []
                 };
             }
        });
        
        // WIPE LIVE DATA
        db_live = {}; 
        localStorage.setItem('pb_live_data', JSON.stringify(db_live));
        if(db_history[oldDate]) localStorage.setItem('pb_history_data', JSON.stringify(db_history));
    }
    
    checkNewDayReset();

    // --- LOGIN LOGIC ---
    document.getElementById('loginPassInput').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') { checkLogin(); }
    });

    function checkLogin() {
        const input = document.getElementById('loginPassInput').value;
        if(input === db_password) {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'flex';
        } else {
            showToast("Wrong Password", "error");
            document.getElementById('loginPassInput').value = '';
        }
    }

    // --- INIT ---
    document.getElementById('displayBizName').textContent = db_bizName;
    document.getElementById('bizNameInput').value = db_bizName;
    document.getElementById('defaultHoursInput').value = db_defaultHours;

    if(db_prefs.dark) {
        document.body.classList.add('dark-mode');
        document.getElementById('darkModeToggle').checked = true;
    }
    renderDateStrip();
    renderAttendanceView();
    renderStaffManager();
    // Increase frequency to check for day rollover
    setInterval(updateHeartbeat, 1000);

    // --- LOGIC ---
    function toggleDarkMode() {
        document.body.classList.toggle('dark-mode');
        db_prefs.dark = document.body.classList.contains('dark-mode');
        localStorage.setItem('pb_prefs', JSON.stringify(db_prefs));
    }

    // EXPORT LOGIC
    function exportToExcel() {
        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "Date,Staff Name,First In,Last Out,Total Work Duration\r\n";

        const dates = Object.keys(db_history).sort().reverse();
        dates.forEach(date => {
            const dayData = db_history[date];
            Object.keys(dayData).forEach(name => {
                const r = dayData[name];
                const inTime = r.startTime ? new Date(r.startTime).toLocaleTimeString() : '--:--';
                const outTime = r.endTime ? new Date(r.endTime).toLocaleTimeString() : '--:--';
                const workStr = formatTime(r.workMs);

                const row = `${date},${name},${inTime},${outTime},${workStr}`;
                csvContent += row + "\r\n";
            });
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `attendance_export_${appState.todayStr}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showToast("Excel (CSV) Downloaded", "success");
    }

    function switchTab(tabName, el) {
        document.querySelectorAll('.view-section').forEach(d => d.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(d => d.classList.remove('active'));
        document.getElementById('view-' + tabName).classList.add('active');
        el.classList.add('active');
        document.getElementById('statsRow').style.display = (tabName === 'attendance') ? 'flex' : 'none';
        if(tabName === 'history') renderHistoryView();
    }

    function pickDate(val) {
        if(!val) return;
        appState.selectedDate = val;
        renderDateStrip();
        renderAttendanceView();
    }

    function renderDateStrip() {
        const strip = document.getElementById('dateStrip');
        strip.innerHTML = '';
        const centerDate = new Date(appState.selectedDate);
        for(let i=-2; i<=2; i++) {
            const d = new Date(centerDate);
            d.setDate(centerDate.getDate() + i);
            const dateKey = new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
            const isToday = (dateKey === appState.todayStr);
            const isActive = (dateKey === appState.selectedDate);
            const el = document.createElement('div');
            el.className = `date-item ${isActive ? 'active' : ''}`;
            el.onclick = () => { appState.selectedDate = dateKey; renderDateStrip(); renderAttendanceView(); };
            const dayName = isToday ? 'TODAY' : d.toLocaleDateString('en-US',{weekday:'short'});
            el.innerHTML = `<span class="date-day">${dayName}</span><span class="date-num">${d.getDate()}</span>`;
            strip.appendChild(el);
        }
    }

    function renderAttendanceView() {
        const container = document.getElementById('attendanceContainer');
        container.innerHTML = '';
        const isLive = (appState.selectedDate === appState.todayStr);
        const isFuture = (appState.selectedDate > appState.todayStr);
        
        // Show staff if: Joined Date <= Selected Date OR History exists for this date
        let activeStaff = db_staff.filter(s => {
            const hasHistory = db_history[appState.selectedDate] && db_history[appState.selectedDate][s.name];
            return (s.joined <= appState.selectedDate) || hasHistory;
        });

        const removedForDay = db_removed[appState.selectedDate] || [];
        activeStaff = activeStaff.filter(s => !removedForDay.includes(s.name));

        if(activeStaff.length === 0) {
            container.innerHTML = `<div style="text-align:center; padding:40px; color:var(--text-sub); font-size:0.9rem;">No staff visible.<br>Use <b>+</b> to add staff.</div>`;
            updateStats(0,0,0);
            return;
        }

        let p=0, a=0, totalH=0;

        activeStaff.forEach(s => {
            const name = s.name;
            let status = 'out', wMs = 0, label = 'Mark', pillClass = 'pill-idle';

            if(isFuture) { label = 'Not Marked'; pillClass = 'pill-idle'; } 
            else if(isLive) {
                if(!db_live[name]) db_live[name] = { state: 'out', lastAction: 0, totalWorkMs: 0, startTime: null, date: appState.todayStr, punches: [] };
                const l = db_live[name];
                
                // Initialize punches array if missing
                if(!l.punches) l.punches = [];
                
                // --- FAILSAFE: Check if this "Live" data is actually stale (from yesterday)
                if(l.date && l.date !== appState.todayStr) {
                    // Stale data detected! Reset this person individually.
                    l.state = 'out'; l.totalWorkMs = 0; l.startTime = null; l.date = appState.todayStr; l.punches = [];
                    // Save cleaned state
                    localStorage.setItem('pb_live_data', JSON.stringify(db_live));
                }

                status = l.state;
                wMs = calcTotalTime(l);

                if(status === 'in') { label = 'Punched In'; pillClass = 'pill-in'; p++; }
                else if(l.totalWorkMs > 0) { label = 'Present (Out)'; pillClass = 'pill-out'; p++; }
                else if(status === 'absent') { label = 'Absent'; pillClass = 'pill-absent'; a++; }
                else { a++; }
            } else {
                const h = db_history[appState.selectedDate];
                if(h && h[name]) { 
                    if(h[name].status === 'absent') {
                        status = 'absent'; wMs = 0;
                        label = 'Absent'; pillClass = 'pill-absent'; a++;
                    } else {
                        status = 'done'; wMs = h[name].workMs || 0; 
                        label = 'Present'; pillClass = 'pill-out'; p++; 
                    }
                } else { label = 'Absent'; pillClass = 'pill-out'; a++; }
            }

            totalH += wMs;
            const safeName = name.replace(/\s/g, '_');
            
            // Check for overtime
            const staffDefaultHours = s.defaultHours || db_defaultHours;
            const defaultHoursMs = staffDefaultHours * 3600000;
            const isOvertime = wMs > defaultHoursMs;
            const overtimeMs = isOvertime ? (wMs - defaultHoursMs) : 0;
            const overtimePill = isOvertime ? `<div class="pill pill-overtime">OT: ${formatTime(overtimeMs)}</div>` : '';

            container.innerHTML += `
                <div class="staff-card" onclick="openActionModal('${name}')">
                    <div class="card-row-top">
                        <div style="display:flex; align-items:center;">
                            <div class="avatar">${name[0]}</div>
                            <div style="font-weight:600; color:var(--text-main);">${name}</div>
                        </div>
                        <div style="display:flex; gap:5px; align-items:center;">
                            ${overtimePill}
                            <div class="pill ${pillClass}">${label}</div>
                        </div>
                    </div>
                    <div class="card-row-bottom">
                        <div class="mini-stat">
                            <span class="mini-label">Status</span>
                            <span class="mini-val" style="color:${status==='in'?'var(--green)':'var(--text-sub)'}">${status==='in'?'Active Now':(status==='absent'?'Absent':'Checked Out')}</span>
                        </div>
                        <div class="mini-stat" style="text-align:right;">
                            <span class="mini-label">Total Work Today</span>
                            <span id="t-${safeName}" class="mini-val val-work ${status==='in'?'ticking':''}">${formatTime(wMs)}</span>
                        </div>
                    </div>
                </div>
            `;
        });
        updateStats(p, a, totalH);
    }

    function renderStaffManager() {
        const container = document.getElementById('manageStaffContainer');
        container.innerHTML = '';
        if(db_staff.length === 0) {
            container.innerHTML = `<div style="padding:15px; color:var(--text-sub); text-align:center;">List is empty.</div>`;
            return;
        }
        db_staff.forEach(s => {
            const joinDate = s.joined ? new Date(s.joined).toLocaleDateString() : 'Unknown';
            container.innerHTML += `
                <div class="manage-item">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div class="avatar" style="width:32px; height:32px; font-size:0.8rem;">${s.name[0]}</div>
                        <div>
                            <div style="font-weight:600; color:var(--text-main);">${s.name}</div>
                            <div style="font-size:0.7rem; color:var(--text-sub);">Joined: ${joinDate}</div>
                        </div>
                    </div>
                    <i class="fas fa-trash-alt btn-trash" onclick="deletePermanent('${s.name}')"></i>
                </div>
            `;
        });
    }

    function addNewStaff() {
        const input = document.getElementById('newStaffInput');
        const name = input.value.trim();
        if(!name) return;
        
        // CORE FIX 2: JOIN DATE IS THE VIEWED DATE (so they appear if added on past date)
        const joinDate = appState.selectedDate; 
        
        db_staff.push({ name: name, joined: joinDate, defaultHours: 8 });
        localStorage.setItem('pb_db_staff', JSON.stringify(db_staff));
        
        if(db_removed[appState.selectedDate]) {
             db_removed[appState.selectedDate] = db_removed[appState.selectedDate].filter(n => n !== name);
             localStorage.setItem('pb_removed_data', JSON.stringify(db_removed));
        }

        input.value = '';
        renderStaffManager();
        renderAttendanceView();
        showToast("Staff Added!", "success");
    }

    function openActionModal(name) {
        // ALLOW PREVIOUS DATES
        if(appState.selectedDate > appState.todayStr) { showToast("Future dates are read-only", "error"); return; }
        appState.activeStaffId = name;
        document.getElementById('modalName').textContent = name;
        document.getElementById('actionModal').style.display = 'flex';
        updateActionUI();
    }
    function closeModal() { document.getElementById('actionModal').style.display = 'none'; appState.activeStaffId = null; }

    function updateActionUI() {
        const name = appState.activeStaffId;
        const container = document.getElementById('modalActions');
        const manualSection = document.getElementById('modalManualSection');
        
        const isLive = (appState.selectedDate === appState.todayStr);
        const isPast = (appState.selectedDate < appState.todayStr);

        let w = 0;
        if(isLive) {
            const l = db_live[name];
            w = calcTotalTime(l);
        } else {
            const h = db_history[appState.selectedDate];
            if(h && h[name]) { w = h[name].workMs || 0; }
        }
        document.getElementById('modalTotalTimer').textContent = formatTime(w);
        
        // ALLOW MANUAL EDIT FOR PAST DATES
        manualSection.style.display = (isLive || isPast) ? 'block' : 'none';
        
        // Populate punch edit list for past dates
        if(isPast) {
            renderPunchEditList();
        }
        
        container.innerHTML = '';
        
        if(isLive) {
            const l = db_live[name];
            // New Logic: Just In or Out
            if(l.state === 'out' || l.state === 'idle' || l.state === 'absent') {
                container.innerHTML = `
                    <button class="action-btn" style="background:var(--green); color:white" onclick="changeState('in')"><i class="fas fa-fingerprint"></i> Punch In</button>
                    ${l.state !== 'absent' ? `<button class="action-btn btn-absent" onclick="changeState('absent')"><i class="fas fa-user-times"></i> Mark Absent</button>` : `<button class="action-btn" onclick="changeState('idle')" style="background:#eee; color:#333">Undo Absent</button>`}
                `;
            } else if(l.state === 'in') {
                container.innerHTML = `<button class="action-btn" style="background:var(--red); color:white" onclick="changeState('out')"><i class="fas fa-sign-out-alt"></i> Punch Out</button>`;
            }
        } else {
             // For past dates, don't show Punch In/Out buttons, but keep the manual edit box
             container.innerHTML = `<div style="text-align:center; padding:10px; color:var(--text-sub); font-size:0.9rem;">Historical Record</div><button class="action-btn" onclick="removeStaffFromDay()" style="background:var(--bg); border:1px solid var(--border); color:var(--text-sub); margin-top:10px;"><i class="fas fa-eye-slash"></i> Hide from this Date</button>`;
        }
    }
    
    // --- PUNCH EDITING FUNCTIONS ---
    function renderPunchEditList() {
        const name = appState.activeStaffId;
        const dateKey = appState.selectedDate;
        const container = document.getElementById('punchEditList');
        
        if(!db_history[dateKey] || !db_history[dateKey][name]) {
            container.innerHTML = '<div style="text-align:center; padding:10px; color:var(--text-sub); font-size:0.85rem;">No punches recorded</div>';
            return;
        }
        
        const record = db_history[dateKey][name];
        if(!record.punches || record.punches.length === 0) {
            // Legacy data - create punches from startTime/endTime
            record.punches = [];
            if(record.startTime) record.punches.push({type: 'in', time: record.startTime});
            if(record.endTime) record.punches.push({type: 'out', time: record.endTime});
        }
        
        container.innerHTML = '';
        record.punches.forEach((punch, index) => {
            const timeStr = new Date(punch.time).toTimeString().slice(0,5); // HH:MM
            const icon = punch.type === 'in' ? 'fa-sign-in-alt' : 'fa-sign-out-alt';
            const label = punch.type === 'in' ? 'IN' : 'OUT';
            const color = punch.type === 'in' ? 'var(--green)' : 'var(--red)';
            
            container.innerHTML += `
                <div style="display:flex; gap:8px; align-items:center; background:var(--bg); padding:8px; border-radius:6px;">
                    <i class="fas ${icon}" style="color:${color}; width:20px;"></i>
                    <span style="font-weight:600; font-size:0.85rem; color:${color}; min-width:35px;">${label}</span>
                    <input type="time" value="${timeStr}" class="pb-input" style="flex:1; padding:6px; font-size:0.9rem;" onchange="updatePunchTime(${index}, this.value)">
                    <i class="fas fa-trash-alt" style="color:var(--red); cursor:pointer; padding:8px;" onclick="deletePunch(${index})" title="Delete"></i>
                </div>
            `;
        });
    }
    
    function updatePunchTime(index, timeStr) {
        const name = appState.activeStaffId;
        const dateKey = appState.selectedDate;
        
        if(!timeStr) return;
        
        const [h, m] = timeStr.split(':');
        const [y, mo, d] = dateKey.split('-').map(Number);
        const newTime = new Date();
        newTime.setFullYear(y, mo - 1, d);
        newTime.setHours(h, m, 0, 0);
        
        const record = db_history[dateKey][name];
        record.punches[index].time = newTime.getTime();
        
        // Recalculate everything
        recalculateFromPunches(dateKey, name);
        
        updateActionUI();
        renderAttendanceView();
        showToast("Punch time updated", "success");
    }
    
    function deletePunch(index) {
        const name = appState.activeStaffId;
        const dateKey = appState.selectedDate;
        
        if(!confirm("Delete this punch?")) return;
        
        const record = db_history[dateKey][name];
        record.punches.splice(index, 1);
        
        // Recalculate everything
        recalculateFromPunches(dateKey, name);
        
        updateActionUI();
        renderAttendanceView();
        showToast("Punch deleted", "success");
    }
    
    function addNewPunch() {
        const name = appState.activeStaffId;
        const dateKey = appState.selectedDate;
        
        if(!db_history[dateKey]) db_history[dateKey] = {};
        if(!db_history[dateKey][name]) {
            db_history[dateKey][name] = { workMs: 0, startTime: null, endTime: null, status: 'present', punches: [] };
        }
        
        const record = db_history[dateKey][name];
        if(!record.punches) record.punches = [];
        
        // Determine type based on last punch
        const lastPunch = record.punches[record.punches.length - 1];
        const newType = (!lastPunch || lastPunch.type === 'out') ? 'in' : 'out';
        
        // Default time: current time if today, or 9 AM if past date
        const [y, mo, d] = dateKey.split('-').map(Number);
        const defaultTime = new Date();
        defaultTime.setFullYear(y, mo - 1, d);
        if(dateKey < appState.todayStr) {
            defaultTime.setHours(9, 0, 0, 0);
        }
        
        record.punches.push({ type: newType, time: defaultTime.getTime() });
        
        // Recalculate everything
        recalculateFromPunches(dateKey, name);
        
        updateActionUI();
        renderAttendanceView();
        showToast(`Added ${newType.toUpperCase()} punch`, "success");
    }
    
    function recalculateFromPunches(dateKey, name) {
        const record = db_history[dateKey][name];
        
        if(!record.punches || record.punches.length === 0) {
            record.workMs = 0;
            record.startTime = null;
            record.endTime = null;
            record.status = 'absent';
            localStorage.setItem('pb_history_data', JSON.stringify(db_history));
            return;
        }
        
        // Sort punches by time
        record.punches.sort((a, b) => a.time - b.time);
        
        // Calculate work time
        let totalWorkMs = 0;
        let currentSessionStart = null;
        
        record.punches.forEach(punch => {
            if(punch.type === 'in') {
                currentSessionStart = punch.time;
            } else if(punch.type === 'out' && currentSessionStart) {
                totalWorkMs += (punch.time - currentSessionStart);
                currentSessionStart = null;
            }
        });
        
        // Update record
        record.workMs = totalWorkMs;
        record.startTime = record.punches[0].time;
        record.endTime = record.punches[record.punches.length - 1].time;
        record.status = 'present';
        
        localStorage.setItem('pb_history_data', JSON.stringify(db_history));
    }

    // --- SMART LOGIC (DEPRECATED - keeping for compatibility) ---
    function submitSmartUpdate() {
        const type = document.getElementById('editParamSelect').value;
        const timeVal = document.getElementById('manualSingleTime').value;
        if(!timeVal) return showToast("Please select a time.", "error");
        
        const entryTime = parseManualTime(timeVal);
        const entryMs = entryTime.getTime();
        const name = appState.activeStaffId;
        const dateKey = appState.selectedDate;

        // HANDLE PAST DATES
        if(dateKey < appState.todayStr) {
            if(!db_history[dateKey]) db_history[dateKey] = {};
            // Init if missing
            if(!db_history[dateKey][name]) db_history[dateKey][name] = { workMs: 0, startTime: 0, endTime: 0, status: 'present' };
            
            let record = db_history[dateKey][name];
            // FORCE PRESENT STATUS ON EDIT
            record.status = 'present';
            
            if(type === 'fix_in') {
                const oldStartTime = record.startTime;
                // Update the start time
                record.startTime = entryMs;
                
                // Only recalculate workMs if it appears this was a single-session day
                // (i.e., workMs equals endTime - startTime, suggesting no breaks)
                if(record.endTime && record.endTime > 0 && oldStartTime > 0) {
                    const oldCalculatedWork = record.endTime - oldStartTime;
                    // If workMs matches the old simple calculation (within 1 second tolerance)
                    // then this was likely a single session, so we should recalculate
                    if(Math.abs(record.workMs - oldCalculatedWork) < 1000) {
                        if(record.endTime > entryMs) {
                            record.workMs = record.endTime - entryMs;
                        } else {
                            record.workMs = 0;
                        }
                    }
                    // Otherwise, preserve the existing workMs as it accounts for breaks
                }
                showToast("Start Time Updated", "success");
            } 
            else if(type === 'fix_out') {
                const oldEndTime = record.endTime;
                // Update the end time
                record.endTime = entryMs;
                
                // Only recalculate workMs if it appears this was a single-session day
                // (i.e., workMs equals endTime - startTime, suggesting no breaks)
                if(record.startTime && record.startTime > 0 && oldEndTime > 0) {
                    const oldCalculatedWork = oldEndTime - record.startTime;
                    // If workMs matches the old simple calculation (within 1 second tolerance)
                    // then this was likely a single session, so we should recalculate
                    if(Math.abs(record.workMs - oldCalculatedWork) < 1000) {
                        if(entryMs > record.startTime) {
                            record.workMs = entryMs - record.startTime;
                        } else {
                            record.workMs = 0;
                        }
                    }
                    // Otherwise, preserve the existing workMs as it accounts for breaks
                }
                showToast("End Time Updated", "success");
            }
            
            localStorage.setItem('pb_history_data', JSON.stringify(db_history));
            updateActionUI();
            renderAttendanceView();
            return;
        }

        // HANDLE LIVE DATE (TODAY)
        const l = db_live[name];
        
        if(type === 'fix_in') {
            if(l.state !== 'in') return showToast("Must be currently Punched In", "error");
            
            // Calculate the current session duration before we change lastAction
            const currentSessionDuration = Date.now() - l.lastAction;
            
            // Update the last action (start of current session)
            l.lastAction = entryMs;
            
            // Update the first punch time of the day
            l.startTime = entryMs;
            
            showToast("Current session start updated", "success");
        } 
        else if(type === 'fix_out') {
            if(l.state !== 'in') return showToast("Must be currently Punched In", "error");
            // End session retroactively
            const sessionDuration = entryMs - l.lastAction;
            if(sessionDuration < 0) return showToast("Out time cannot be before In time", "error");
            l.totalWorkMs = (l.totalWorkMs || 0) + sessionDuration;
            l.state = 'out';
            l.lastAction = entryMs;
            
            saveHistory(name, l.totalWorkMs, l.startTime, entryMs);
            showToast("Shift Ended Retroactively", "success");
        }

        localStorage.setItem('pb_live_data', JSON.stringify(db_live));
        updateActionUI();
        renderAttendanceView();
    }

    function parseManualTime(timeStr) {
        const [h, m] = timeStr.split(':');
        // Parse the selected date string (YYYY-MM-DD) to integers
        const [y, mo, d] = appState.selectedDate.split('-').map(Number);

        const inputDate = new Date(); 
        // Force the date object to match the selected date exactly
        // Note: Months in JS Date are 0-indexed (0=Jan, 11=Dec)
        inputDate.setFullYear(y, mo - 1, d);
        inputDate.setHours(h, m, 0, 0);
        
        return inputDate;
    }

    function changeState(newState) {
        const name = appState.activeStaffId; const now = Date.now(); 
        const l = db_live[name];
        
        if(newState === 'in') {
            // Start a new session
            l.state = 'in';
            l.lastAction = now; // Mark Start of this segment
            if(!l.startTime) l.startTime = now; // Mark First Punch of day
            if(!l.totalWorkMs) l.totalWorkMs = 0;
            if(!l.punches) l.punches = [];
            l.punches.push({type: 'in', time: now}); // Record punch-in
            // Mark the DATE of this record
            l.date = appState.todayStr;
        } 
        else if(newState === 'out') {
            // End session and accumulate
            if(l.state === 'in') {
                const sessionDuration = now - l.lastAction;
                l.totalWorkMs = (l.totalWorkMs || 0) + sessionDuration;
            }
            l.state = 'out';
            l.lastAction = now; // Mark End time
            if(!l.punches) l.punches = [];
            l.punches.push({type: 'out', time: now}); // Record punch-out
            
            saveHistory(name, l.totalWorkMs, l.startTime, now, 'present', l.punches);
        }
        else if(newState === 'absent') {
            l.state = 'absent';
            l.date = appState.todayStr;
            // Save Absent to History Immediately
            saveHistory(name, 0, null, null, 'absent', []);
        }
        else if(newState === 'idle') {
            l.state = 'out'; // Reset to out/idle
        }

        localStorage.setItem('pb_live_data', JSON.stringify(db_live));
        updateActionUI(); renderAttendanceView();
    }
    
    function saveHistory(name, workMs, start, end, status='present', punches=null) {
         if(!db_history[appState.todayStr]) db_history[appState.todayStr] = {};
         db_history[appState.todayStr][name] = { 
             workMs: workMs, 
             startTime: start, 
             endTime: end,
             status: status,
             punches: punches || [] // Array of {type: 'in'|'out', time: timestamp}
         };
         localStorage.setItem('pb_history_data', JSON.stringify(db_history));
    }

    function calcTotalTime(l) {
        let total = l.totalWorkMs || 0;
        if(l.state === 'in') {
            total += (Date.now() - l.lastAction);
        }
        return total;
    }
    
    function updateHeartbeat() {
        // --- LIVE DATE CHECKER: Detect if date changed while app was open ---
        const realNow = getLocalDateString();
        if (realNow !== appState.todayStr) {
             // New Day Detected while app was running!
             const oldDate = appState.todayStr;
             appState.todayStr = realNow;
             appState.selectedDate = realNow;
             archiveAndResetLiveData(oldDate);
             renderDateStrip();
             renderAttendanceView();
             showToast("New Day Started! Timers Reset.");
             return;
        }

        if(appState.selectedDate !== appState.todayStr) return;
        let totalH = 0; const removedForDay = db_removed[appState.selectedDate] || [];
        const activeStaff = db_staff.filter(s => {
             // For Today, we rely on remove list + joined date
             return s.joined <= appState.selectedDate && !removedForDay.includes(s.name);
        });
        
        activeStaff.forEach(s => {
            const name = s.name; const l = db_live[name]; if(!l) return;
            const w = calcTotalTime(l); totalH += w;
            
            const wEl = document.getElementById(`t-${name.replace(/\s/g, '_')}`);
            if(wEl) wEl.textContent = formatTime(w);
            
            if(appState.activeStaffId === name && document.getElementById('actionModal').style.display === 'flex') {
                document.getElementById('modalTotalTimer').textContent = formatTime(w);
            }
        });
        document.getElementById('statH').textContent = Math.floor(totalH/3600000) + 'h';
    }
    
    function updateStats(p, a, h) {
        document.getElementById('statP').textContent = p; document.getElementById('statA').textContent = a;
        document.getElementById('statH').textContent = Math.floor(h/3600000) + 'h';
    }
    function formatTime(ms) {
        if(ms < 0) ms = 0;
        const totalSec = Math.floor(ms / 1000); const h = Math.floor(totalSec / 3600);
        const m = Math.floor((totalSec % 3600) / 60); const s = totalSec % 60;
        return `${h}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    }
    function formatClockTime(ts) { if(!ts) return '--:--'; return new Date(ts).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}); }
    
    function saveProfile() {
        const n = document.getElementById('bizNameInput').value;
        const dh = document.getElementById('defaultHoursInput').value;
        const p = document.getElementById('passwordInput').value;
        
        db_bizName = n; 
        db_defaultHours = parseFloat(dh) || 8;

        localStorage.setItem('pb_bizName', n);
        localStorage.setItem('pb_defaultHours', dh);

        if(p && p.trim() !== '') {
            db_password = p;
            localStorage.setItem('pb_password', p);
            document.getElementById('passwordInput').value = '';
            showToast("Password Updated", "success");
        }

        document.getElementById('displayBizName').textContent = n; 
        showToast("Saved", "success");
    }

    function resetAllData() {
        showConfirm("Delete ALL data?", () => { localStorage.clear(); location.reload(); }, true);
    }
    function deletePermanent(name) {
        showConfirm(`Delete ${name}?`, () => {
            db_staff = db_staff.filter(s => s.name !== name); delete db_live[name];
            localStorage.setItem('pb_db_staff', JSON.stringify(db_staff)); localStorage.setItem('pb_live_data', JSON.stringify(db_live));
            renderStaffManager(); renderAttendanceView(); showToast("Deleted", "error");
        }, true);
    }
    function removeStaffFromDay() {
        showConfirm("Remove from view?", () => {
            const name = appState.activeStaffId;
            if(!db_removed[appState.selectedDate]) db_removed[appState.selectedDate] = [];
            db_removed[appState.selectedDate].push(name);
            localStorage.setItem('pb_removed_data', JSON.stringify(db_removed));
            if(appState.selectedDate === appState.todayStr) {
                db_live[name] = { state: 'out', lastAction: 0, totalWorkMs: 0, startTime: null, punches: [] };
                localStorage.setItem('pb_live_data', JSON.stringify(db_live));
            }
            closeModal(); renderAttendanceView(); showToast("Removed");
        }, true);
    }
    function openSelectStaffModal() {
        const container = document.getElementById('selectStaffList'); container.innerHTML = '';
        // FIX: Show all staff to allow manual restore
        const eligible = db_staff; 
        
        eligible.forEach(s => {
             container.innerHTML += `<div class="select-item" onclick="addStaffToDay('${s.name}')"><div class="avatar">${s.name[0]}</div><span style="font-weight:600; color:var(--text-main);">${s.name}</span><span style="margin-left:auto; color:var(--pb-blue); font-weight:bold; font-size:0.8rem;">ADD +</span></div>`;
        });
        
        document.getElementById('selectStaffModal').style.display = 'flex';
    }
    function addStaffToDay(name) {
        let list = db_removed[appState.selectedDate] || []; list = list.filter(n => n !== name);
        db_removed[appState.selectedDate] = list; localStorage.setItem('pb_removed_data', JSON.stringify(db_removed));
        
        // CORE FIX 3: UPDATE JOIN DATE IF THIS DATE IS EARLIER
        // This fixes the "gap" in days
        const staffObj = db_staff.find(s => s.name === name);
        if(staffObj && appState.selectedDate < staffObj.joined) {
            staffObj.joined = appState.selectedDate;
            localStorage.setItem('pb_db_staff', JSON.stringify(db_staff));
        }

        // Force a history entry so renderAttendanceView picks them up even if joined date is wrong (fallback)
        if(!db_history[appState.selectedDate]) db_history[appState.selectedDate] = {};
        if(!db_history[appState.selectedDate][name]) {
             db_history[appState.selectedDate][name] = { workMs: 0, startTime: 0, endTime: 0, status: 'absent', punches: [] };
             localStorage.setItem('pb_history_data', JSON.stringify(db_history));
        }
        
        closeSelectModal(); renderAttendanceView();
    }
    function closeSelectModal() { document.getElementById('selectStaffModal').style.display = 'none'; }

    // --- HISTORY FEATURE ---
    function setHistoryMode(mode) {
        appState.historyMode = mode;
        document.getElementById('btnHistDaily').className = `history-btn ${mode === 'daily' ? 'active' : ''}`;
        document.getElementById('btnHistStaff').className = `history-btn ${mode === 'staff' ? 'active' : ''}`;
        renderHistoryView();
    }

    function renderHistoryView() {
        const c = document.getElementById('historyContainer'); c.innerHTML = '';
        
        // MODE 1: DAILY - UPDATED TO SHOW ABSENT
        if(appState.historyMode === 'daily') {
            const historyDates = Object.keys(db_history).sort().reverse();
            if(historyDates.length === 0) { c.innerHTML = '<div style="padding:20px; text-align:center; color:#999">No history data found.</div>'; return; }

            historyDates.forEach(date => {
                const d = db_history[date]; 
                let rows = '';
                
                // Get ALL staff who joined by this date
                const eligibleStaff = db_staff.filter(s => s.joined <= date);
                
                eligibleStaff.forEach(s => {
                    const name = s.name;
                    // Check if they have data for this day
                    if(d[name]) {
                        const info = d[name];
                        if(info.status === 'absent') {
                             rows += `<div class="h-row" style="border-left:3px solid var(--red)"><div class="h-main-row"><span class="h-name">${name}</span><span style="color:var(--red); font-weight:bold; font-size:0.8rem;">ABSENT</span></div></div>`;
                        } else {
                             // Check for overtime
                             const staffDefaultHours = s.defaultHours || db_defaultHours;
                             const defaultHoursMs = staffDefaultHours * 3600000;
                             const isOvertime = info.workMs > defaultHoursMs;
                             const overtimeMs = isOvertime ? (info.workMs - defaultHoursMs) : 0;
                             const overtimeTag = isOvertime ? `<span class="pill pill-overtime" style="margin-left:5px; font-size:0.65rem; padding:2px 8px;">OT: ${formatTime(overtimeMs)}</span>` : '';
                             
                             rows += `<div class="h-row"><div class="h-main-row"><span class="h-name">${name}</span><span class="h-time">${formatTime(info.workMs)}${overtimeTag}</span></div><div class="h-details"><div class="h-detail-item"><i class="fas fa-sign-in-alt"></i> First: ${formatClockTime(info.startTime)}</div><div class="h-detail-item"><i class="fas fa-sign-out-alt"></i> Last: ${formatClockTime(info.endTime)}</div></div></div>`;
                        }
                    } else {
                        // NO DATA = ABSENT
                        rows += `<div class="h-row" style="border-left:3px solid var(--red); opacity:0.7;"><div class="h-main-row"><span class="h-name">${name}</span><span style="color:var(--red); font-weight:bold; font-size:0.8rem;">ABSENT (No Data)</span></div></div>`;
                    }
                });
                
                c.innerHTML += `<div class="history-date-block"><div class="h-header"><span>${date}</span></div>${rows}</div>`;
            });
        } 
        // MODE 2: STAFF LIST
        else {
            db_staff.forEach(s => {
                 c.innerHTML += `
                    <div class="history-date-block" onclick="openMonthSelect('${s.name}')" style="cursor:pointer">
                        <div class="h-header" style="border:none">
                             <div style="display:flex; align-items:center; gap:10px;">
                                <div class="avatar" style="width:30px; height:30px; font-size:0.8rem;">${s.name[0]}</div>
                                <span>${s.name}</span>
                             </div>
                             <i class="fas fa-chevron-right" style="color:var(--text-sub)"></i>
                        </div>
                    </div>
                 `;
            });
        }
    }

    // --- MONTH SELECT MODAL ---
    function openMonthSelect(name) {
        appState.reportStaff = name;
        document.getElementById('monthSelectTitle').innerText = "Report for " + name;
        document.getElementById('reportMonthInput').value = new Date().toISOString().slice(0, 7); // yyyy-mm
        document.getElementById('monthSelectModal').style.display = 'flex';
    }
    function closeMonthModal() {
        document.getElementById('monthSelectModal').style.display = 'none';
        appState.reportStaff = null;
    }
    function generateStaffReport() {
        const monthVal = document.getElementById('reportMonthInput').value; // yyyy-mm
        const name = appState.reportStaff;
        closeMonthModal();

        const c = document.getElementById('historyContainer');
        c.innerHTML = `<div style="margin-bottom:10px; font-weight:bold; text-align:center;">${name} - ${monthVal}</div><div class="action-btn" onclick="renderHistoryView()" style="background:var(--bg); color:var(--text-sub); width:auto; display:inline-block; padding:5px 15px; margin-bottom:15px; font-size:0.8rem;">&larr; Back to List</div>`;
        
        let totalMonthMs = 0;
        
        // FIND JOIN DATE
        const staffObj = db_staff.find(s => s.name === name);
        const joinDate = staffObj ? staffObj.joined : '2099-01-01';

        // GENERATE ALL DAYS OF MONTH UP TO TODAY
        const [y, m] = monthVal.split('-').map(Number);
        const daysInMonth = new Date(y, m, 0).getDate();
        
        let htmlBuffer = '';

        for(let d = 1; d <= daysInMonth; d++) {
            const dateStr = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            
            // Stop if future
            if(dateStr > appState.todayStr) break;
            
            // Skip if before joined
            if(dateStr < joinDate) continue;

            const dayData = (db_history[dateStr] && db_history[dateStr][name]) ? db_history[dateStr][name] : null;

            if(dayData) {
                // HAS DATA
                if(dayData.status === 'absent') {
                    htmlBuffer += `
                    <div class="history-date-block" style="border-left: 4px solid var(--red);">
                        <div class="h-header"><span>${dateStr}</span> <span style="color:var(--red); font-weight:bold;">ABSENT</span></div>
                    </div>`;
                } else {
                    totalMonthMs += dayData.workMs;
                    
                    // Check for overtime
                    const staffDefaultHours = staffObj.defaultHours || db_defaultHours;
                    const defaultHoursMs = staffDefaultHours * 3600000;
                    const isOvertime = dayData.workMs > defaultHoursMs;
                    const overtimeMs = isOvertime ? (dayData.workMs - defaultHoursMs) : 0;
                    const overtimeTag = isOvertime ? `<span class="pill pill-overtime" style="margin-left:5px; font-size:0.65rem; padding:2px 8px;">OT: ${formatTime(overtimeMs)}</span>` : '';
                    
                    htmlBuffer += `
                    <div class="history-date-block">
                        <div class="h-header"><span>${dateStr}</span> <span style="color:var(--pb-blue)">${formatTime(dayData.workMs)}${overtimeTag}</span></div>
                        <div class="h-details" style="padding:10px; background:var(--card-bg)">
                            <div class="h-detail-item">FIRST IN: ${formatClockTime(dayData.startTime)}</div>
                            <div class="h-detail-item">LAST OUT: ${formatClockTime(dayData.endTime)}</div>
                        </div>
                    </div>`;
                }
            } else {
                // NO DATA = ABSENT (Since date >= joined)
                htmlBuffer += `
                <div class="history-date-block" style="border-left: 4px solid var(--red); opacity:0.8;">
                    <div class="h-header"><span>${dateStr}</span> <span style="color:var(--red); font-weight:bold;">ABSENT</span></div>
                </div>`;
            }
        }

        if(htmlBuffer === '') {
            c.innerHTML += `<div style="text-align:center; padding:30px; color:var(--text-sub)">No data found for this month.</div>`;
        } else {
            c.innerHTML = `<div style="background:var(--pb-blue); color:white; padding:15px; border-radius:8px; margin-bottom:15px; text-align:center;">
                <div style="font-size:0.8rem; opacity:0.8;">TOTAL HOURS (${monthVal})</div>
                <div style="font-size:1.5rem; font-weight:bold;">${Math.floor(totalMonthMs/3600000)}h ${Math.floor((totalMonthMs%3600000)/60000)}m</div>
            </div>` + htmlBuffer;
        }
    }
   
    window.addEventListener('storage', function(e) {
        if(e.key === 'pb_live_data' || e.key === 'pb_sync_trigger') {
            db_staff = JSON.parse(localStorage.getItem('pb_db_staff')) || []; 
            db_live = JSON.parse(localStorage.getItem('pb_live_data')) || {};
            renderAttendanceView();
        }
    });

</script>
</body>
</html>
